<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QQ ç¾¤èŠæ•°æ®æ´å¯Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // è‡ªå®šä¹‰æ·±è‰²èƒŒæ™¯
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <script>
        // åˆå§‹åŒ–ä¸»é¢˜ï¼Œé˜²æ­¢é—ªå±
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        /* æ»šåŠ¨æ¡é€‚é… */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .mobile-hide { display: none; }
        @media (min-width: 768px) { .mobile-hide { display: block; } }
        
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .dark .tab-active { border-bottom: 2px solid #60a5fa; color: #60a5fa; }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .mobile-auto-height { height: auto !important; overflow: visible !important; }
            .mobile-sticky-nav { position: sticky; bottom: 0; z-index: 40; }
            /* æµ…è‰²æ¨¡å¼èƒŒæ™¯æ¨¡ç³Š */
            .mobile-sticky-nav { background: rgba(255,255,255,0.95); backdrop-filter: blur(4px); }
            /* æ·±è‰²æ¨¡å¼èƒŒæ™¯æ¨¡ç³Š */
            .dark .mobile-sticky-nav { background: rgba(15, 23, 42, 0.95); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 h-screen flex flex-col overflow-hidden font-sans transition-colors duration-200">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 h-14 flex items-center justify-between px-4 shrink-0 z-20 shadow-sm transition-colors duration-200">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/30">Q</div>
            <h1 class="font-bold text-lg tracking-tight dark:text-white">Group Member Insight</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
            <button onclick="toggleTheme()" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors focus:outline-none" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">
                <!-- Sun Icon -->
                <svg id="icon-sun" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Moon Icon -->
                <svg id="icon-moon" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>

            <!-- ç”¨æˆ·é€‰æ‹©å™¨ -->
            <div class="relative group">
                <button id="user-selector-btn" onclick="document.getElementById('user-selector-menu').classList.toggle('hidden')" 
                        class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-full text-sm font-medium transition-colors border border-transparent dark:border-slate-700">
                    <span id="current-user-display" class="dark:text-slate-300">é€‰æ‹©æ•°æ®æº</span>
                    <svg class="w-4 h-4 text-gray-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <!-- ä¸‹æ‹‰èœå• -->
                <div id="user-selector-menu" class="hidden absolute right-0 top-full mt-2 w-56 bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-gray-100 dark:border-slate-800 p-2 z-50">
                    <div class="text-xs font-bold text-gray-400 px-2 py-1 uppercase">å·²å¯¼å…¥çš„ QQ</div>
                    <div id="user-list-container" class="max-h-48 overflow-y-auto space-y-1 mb-2">
                        <!-- JS å¡«å…… -->
                    </div>
                    <div class="border-t border-gray-100 dark:border-slate-800 pt-2">
                        <button onclick="openManageModal()" class="w-full text-left px-2 py-2 text-sm text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-800 rounded-lg flex items-center gap-2 transition-colors">
                            <span>+ ç®¡ç†/æ·»åŠ æ–°ç”¨æˆ·</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="flex-1 relative overflow-y-auto md:overflow-hidden scroll-smooth transition-colors duration-200" id="main-area">
        <!-- ç©ºçŠ¶æ€ -->
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10 bg-gray-50 dark:bg-slate-950">
            <div class="w-20 h-20 bg-gray-200 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 text-4xl">ğŸ“‚</div>
            <h2 class="text-xl font-bold text-gray-700 dark:text-slate-200">è¯·é€‰æ‹©æˆ–å¯¼å…¥æ•°æ®</h2>
            <p class="text-gray-500 dark:text-slate-400 mt-2 max-w-xs text-sm">é€‰æ‹©ä¸€ä¸ª QQ å·çš„æ•°æ®é›†å¼€å§‹åˆ†æï¼Œæˆ–è€…ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ–°æ•°æ®ã€‚</p>
            <button onclick="openManageModal()" class="mt-6 px-6 py-2.5 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition font-medium">å»ç®¡ç†æ•°æ®</button>
        </div>

        <!-- åˆ†æç•Œé¢ (é»˜è®¤éšè—) -->
        <div id="analysis-view" class="hidden min-h-full md:h-full flex flex-col md:flex-row">
            
            <!-- ä¾§è¾¹æ /åº•éƒ¨æ  -->
            <nav class="bg-white dark:bg-slate-900 border-t md:border-t-0 md:border-r border-gray-200 dark:border-slate-800 md:w-64 shrink-0 flex md:flex-col justify-around md:justify-start p-2 md:p-4 z-30 order-2 md:order-1 mobile-sticky-nav shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] md:shadow-none transition-colors duration-200">
                <button onclick="switchTab('tab1')" id="nav-tab1" class="flex flex-col md:flex-row items-center md:gap-3 p-2 rounded-lg text-gray-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-800 transition active-nav">
                    <span class="text-xl">ğŸ†</span>
                    <span class="text-xs md:text-sm font-medium">æ•°é‡æ’è¡Œ</span>
                </button>
                <button onclick="switchTab('tab2')" id="nav-tab2" class="flex flex-col md:flex-row items-center md:gap-3 p-2 rounded-lg text-gray-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-800 transition">
                    <span class="text-xl">ğŸ•¸ï¸</span>
                    <span class="text-xs md:text-sm font-medium">ç¾¤æ¸—é€åº¦</span>
                </button>
                <button onclick="switchTab('tab3')" id="nav-tab3" class="flex flex-col md:flex-row items-center md:gap-3 p-2 rounded-lg text-gray-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-800 transition">
                    <span class="text-xl">ğŸ”—</span>
                    <span class="text-xs md:text-sm font-medium">å¤šç¾¤äº¤é›†</span>
                </button>
            </nav>

            <!-- å†…å®¹æ˜¾ç¤ºåŒº -->
            <div class="flex-1 bg-gray-50 dark:bg-slate-950 relative order-1 md:order-2 md:overflow-hidden transition-colors duration-200">
                
                <!-- Tab 1: æ´»è·ƒç”¨æˆ· -->
                <div id="tab1" class="w-full min-h-full md:h-full flex flex-col p-4 md:p-8 md:overflow-y-auto">
                    <div class="mb-4">
                        <h2 class="text-xl font-bold dark:text-white">ç¾¤èŠæ•°é‡æ’å</h2>
                        <p class="text-sm text-gray-500 dark:text-slate-400">å…±åŒç¾¤èŠæ•°é‡ >= 2 çš„ç”¨æˆ·</p>
                    </div>
                    <div id="tab1-content" class="space-y-3 pb-4 md:pb-20"></div>
                </div>

                <!-- Tab 2: æ¸—é€æŸ¥è¯¢ -->
                <div id="tab2" class="hidden w-full min-h-full md:h-full flex flex-col p-4 md:p-8 md:overflow-hidden">
                    <div class="mb-4">
                        <h2 class="text-xl font-bold dark:text-white">ç¾¤æˆå‘˜æ¸—é€æŸ¥è¯¢</h2>
                        <p class="text-sm text-gray-500 dark:text-slate-400">æŸ¥è¯¢æŒ‡å®šç¾¤èŠæˆå‘˜è¿˜åœ¨å“ªäº›ç¾¤èŠ</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 md:h-full pb-4 md:pb-20">
                        <!-- æœç´¢æ¡†åŒºåŸŸ -->
                        <div class="md:w-1/3 flex flex-col bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800 overflow-hidden shrink-0 h-80 md:h-auto">
                            <input type="text" placeholder="æœç´¢ç¾¤èŠ..." oninput="debounceSearch(this.value, 'search-res-2')" class="p-3 border-b border-gray-100 dark:border-slate-800 bg-transparent outline-none text-sm shrink-0 dark:text-slate-200 dark:placeholder-slate-500">
                            <div id="search-res-2" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                        </div>
                        
                        <!-- ç»“æœåŒºåŸŸ -->
                        <div class="flex-1 bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800 flex flex-col h-auto md:overflow-hidden">
                            <div class="p-3 border-b border-gray-100 dark:border-slate-800 bg-gray-50 dark:bg-slate-950 font-medium text-sm shrink-0 sticky top-0 z-10 dark:text-slate-300" id="tab2-header">è¯·é€‰æ‹©ç¾¤èŠ</div>
                            <div id="tab2-content" class="p-3 space-y-2 h-auto md:flex-1 md:overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: äº¤é›† -->
                <div id="tab3" class="hidden w-full min-h-full md:h-full flex flex-col p-4 md:p-8 md:overflow-hidden">
                    <h2 class="text-xl font-bold mb-4 dark:text-white">å¤šç¾¤äº¤é›†æŸ¥è¯¢</h2>
                    <div class="flex flex-col md:flex-row gap-4 md:h-full pb-4 md:pb-20">
                        <!-- è¾“å…¥ä¸é€‰æ‹©åŒºåŸŸ -->
                        <div class="md:w-1/3 flex flex-col bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800 overflow-hidden shrink-0 h-auto md:h-full">
                            <div class="p-3">
                                <input type="text" placeholder="æ·»åŠ ç¾¤èŠ..." oninput="debounceSearch(this.value, 'search-res-3')" class="w-full p-2 border border-gray-200 dark:border-slate-700 rounded text-sm mb-2 outline-none focus:border-blue-500 dark:bg-slate-950 dark:text-slate-200 dark:placeholder-slate-500">
                                <div id="search-res-3" class="h-32 md:h-48 overflow-y-auto border border-gray-100 dark:border-slate-800 rounded bg-gray-50 dark:bg-slate-950 mb-2 p-1"></div>
                                <div class="flex justify-between items-center text-sm font-bold text-gray-700 dark:text-slate-300 mb-2">
                                    <span>å·²é€‰: <span id="sel-count">0</span></span>
                                    <button onclick="runIntersection()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">æŸ¥è¯¢</button>
                                </div>
                                <div id="sel-list" class="flex-1 overflow-y-auto space-y-1 min-h-[100px] max-h-[200px] md:max-h-none"></div>
                            </div>
                        </div>
                        
                        <!-- ç»“æœåŒºåŸŸ -->
                        <div class="flex-1 bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800 flex flex-col h-auto md:overflow-hidden">
                            <div class="p-3 border-b border-gray-100 dark:border-slate-800 bg-gray-50 dark:bg-slate-950 font-medium text-sm flex justify-between shrink-0 sticky top-0 z-10 dark:text-slate-300">
                                <span>ç»“æœåˆ—è¡¨</span>
                                <span id="tab3-res-count" class="text-gray-500 dark:text-slate-400">0 äºº</span>
                            </div>
                            <div id="tab3-content" class="p-3 grid grid-cols-2 lg:grid-cols-4 gap-3 content-start h-auto md:flex-1 md:overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="manage-modal" class="hidden fixed inset-0 z-50 bg-gray-900/50 dark:bg-slate-950/70 backdrop-blur-sm flex items-center justify-center p-0 md:p-4">
        <div class="bg-white dark:bg-slate-900 w-full h-full md:h-auto md:max-w-2xl md:rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in-up transition-colors duration-200">
            <div class="p-4 border-b border-gray-200 dark:border-slate-800 flex justify-between items-center bg-gray-50 dark:bg-slate-950">
                <h3 class="font-bold text-lg dark:text-white">æ•°æ®ç®¡ç†</h3>
                <button onclick="document.getElementById('manage-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300">âœ•</button>
            </div>
            
            <div class="flex border-b border-gray-200 dark:border-slate-800 text-sm font-medium text-gray-600 dark:text-slate-400">
                <button onclick="switchManageTab('m-termux')" class="flex-1 py-3 hover:bg-gray-50 dark:hover:bg-slate-800 manage-tab-btn border-b-2 border-blue-600 text-blue-600 dark:text-blue-400" data-target="m-termux">Termux ä¸€é”®</button>
                <button onclick="switchManageTab('m-manual')" class="flex-1 py-3 hover:bg-gray-50 dark:hover:bg-slate-800 manage-tab-btn border-b-2 border-transparent" data-target="m-manual">æ–‡ä»¶å¤„ç†</button>
                <button onclick="switchManageTab('m-json')" class="flex-1 py-3 hover:bg-gray-50 dark:hover:bg-slate-800 manage-tab-btn border-b-2 border-transparent" data-target="m-json">JSON å¯¼å…¥</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-slate-900">
                <!-- Termux æ¨¡å¼ -->
                <div id="m-termux" class="manage-content space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 p-3 rounded-lg text-sm">
                        æ­¤åŠŸèƒ½ä»…åœ¨å·² Root çš„å®‰å“è®¾å¤‡ Termux (tsuç¯å¢ƒ) ä¸‹å¯ç”¨ã€‚ä¼šè‡ªåŠ¨ä» QQ ç›®å½•å¤åˆ¶å¹¶è§£å¯†æ•°æ®ã€‚
                    </div>
                    <div id="termux-uid-list" class="space-y-2">
                        <div class="text-center py-4 text-gray-400 dark:text-slate-500">æ­£åœ¨æ‰«ææœ¬åœ° QQ...</div>
                    </div>
                    <label class="flex items-center gap-2 text-sm mt-4 dark:text-slate-300">
                        <input type="checkbox" id="termux-clean" class="rounded text-blue-600 dark:bg-slate-800 dark:border-slate-600">
                        <span>å®Œæˆååˆ é™¤ä¸­é—´æ–‡ä»¶ (æ¨è)</span>
                    </label>
                </div>

                <!-- Manual æ¨¡å¼ -->
                <div id="m-manual" class="hidden manage-content space-y-4">
                    <div class="text-sm text-gray-600 dark:text-slate-400 space-y-2">
                        <p>è¯·å°†ç›¸å…³æ–‡ä»¶æ‰‹åŠ¨æ”¾å…¥ <code>./data/{QQå·}/</code> ç›®å½•ã€‚</p>
                        <p><a href="https://docs.aaqwq.top/decrypt/description.html" target="_blank" class="text-blue-600 dark:text-blue-400 underline">æŸ¥çœ‹è§£å¯†æ•™ç¨‹ & keyè·å–</a></p>
                    </div>
                    <div class="grid gap-3">
                        <div class="flex gap-2">
                            <input type="text" id="manual-qq" placeholder="è¾“å…¥ç›®æ ‡ QQ å·" class="border p-2 rounded flex-1 dark:bg-slate-950 dark:border-slate-700 dark:text-white dark:placeholder-slate-500">
                            <button onclick="createUserFolder('manual-qq')" class="bg-gray-200 dark:bg-slate-800 hover:bg-gray-300 dark:hover:bg-slate-700 px-3 rounded text-sm text-gray-700 dark:text-slate-300 whitespace-nowrap transition-colors">åˆ›å»ºæ–‡ä»¶å¤¹</button>
                        </div>
                        <input type="text" id="manual-key" placeholder="è§£å¯† Key (å¯é€‰ï¼Œè‹¥æä¾›åˆ™è·³è¿‡è®¡ç®—)" class="border p-2 rounded w-full dark:bg-slate-950 dark:border-slate-700 dark:text-white dark:placeholder-slate-500">
                        <input type="text" id="manual-ntuid" placeholder="nt_uid (è‹¥æ—  Key å¿…é¡»æä¾›)" class="border p-2 rounded w-full dark:bg-slate-950 dark:border-slate-700 dark:text-white dark:placeholder-slate-500">
                    </div>

                    <div class="space-y-2 mt-4">
                        <div class="flex items-center justify-between border p-3 rounded hover:bg-gray-50 dark:border-slate-800 dark:hover:bg-slate-800 transition-colors">
                            <div>
                                <div class="font-bold text-sm dark:text-slate-200">é˜¶æ®µ 1: åŸå§‹æ–‡ä»¶</div>
                                <div class="text-xs text-gray-500 dark:text-slate-400">å·²æ”¾ç½® group_info.db</div>
                            </div>
                            <button onclick="runManual('raw')" class="bg-slate-800 dark:bg-slate-700 text-white px-3 py-1 rounded text-sm hover:bg-slate-900 dark:hover:bg-slate-600 transition-colors">æ‰§è¡Œå…¨æµç¨‹</button>
                        </div>
                        <div class="flex items-center justify-between border p-3 rounded hover:bg-gray-50 dark:border-slate-800 dark:hover:bg-slate-800 transition-colors">
                            <div>
                                <div class="font-bold text-sm dark:text-slate-200">é˜¶æ®µ 2: å·²å»å¤´æ–‡ä»¶</div>
                                <div class="text-xs text-gray-500 dark:text-slate-400">å·²æ”¾ç½® group_info.cleaned.db (éœ€ Key)</div>
                            </div>
                            <button onclick="runManual('cleaned')" class="bg-slate-800 dark:bg-slate-700 text-white px-3 py-1 rounded text-sm hover:bg-slate-900 dark:hover:bg-slate-600 transition-colors">è§£å¯†å¹¶æ¸…æ´—</button>
                        </div>
                        <div class="flex items-center justify-between border p-3 rounded hover:bg-gray-50 dark:border-slate-800 dark:hover:bg-slate-800 transition-colors">
                            <div>
                                <div class="font-bold text-sm dark:text-slate-200">é˜¶æ®µ 3: å·²è§£å¯†æ–‡ä»¶</div>
                                <div class="text-xs text-gray-500 dark:text-slate-400">å·²æ”¾ç½® group_info.decrypted.db</div>
                            </div>
                            <button onclick="runManual('decrypted')" class="bg-slate-800 dark:bg-slate-700 text-white px-3 py-1 rounded text-sm hover:bg-slate-900 dark:hover:bg-slate-600 transition-colors">ä»…æ¸…æ´—å…¥åº“</button>
                        </div>
                    </div>
                </div>

                <!-- JSON æ¨¡å¼ -->
                <div id="m-json" class="hidden manage-content space-y-4">
                    <div class="flex gap-2">
                        <input type="text" id="json-qq" placeholder="è®¾ç½® QQ å·" class="border p-2 rounded flex-1 dark:bg-slate-950 dark:border-slate-700 dark:text-white dark:placeholder-slate-500">
                        <button onclick="createUserFolder('json-qq')" class="bg-gray-200 dark:bg-slate-800 hover:bg-gray-300 dark:hover:bg-slate-700 px-3 rounded text-sm text-gray-700 dark:text-slate-300 whitespace-nowrap transition-colors">åˆ›å»ºæ–‡ä»¶å¤¹</button>
                    </div>
                    <div class="border-2 border-dashed border-gray-300 dark:border-slate-700 rounded-xl p-8 text-center hover:bg-gray-50 dark:hover:bg-slate-800 transition cursor-pointer relative">
                        <input type="file" id="json-file" class="absolute inset-0 opacity-0 cursor-pointer" accept=".json">
                        <div class="text-gray-500 dark:text-slate-400">ç‚¹å‡»ä¸Šä¼  JSON æ–‡ä»¶</div>
                        <div id="json-filename" class="text-blue-600 dark:text-blue-400 text-sm mt-2"></div>
                    </div>
                    <button onclick="runJsonImport()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold shadow-lg shadow-blue-200 dark:shadow-none hover:bg-blue-700 transition">å¼€å§‹å¯¼å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
    <div id="detail-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/20 dark:bg-black/50 backdrop-blur-sm" onclick="this.parentElement.classList.add('hidden')"></div>
        <div class="relative bg-white dark:bg-slate-900 w-full max-w-sm rounded-xl shadow-2xl flex flex-col max-h-[80vh] overflow-hidden z-10 transition-colors duration-200">
            <div class="p-4 border-b bg-gray-50 dark:bg-slate-950 dark:border-slate-800 flex justify-between shrink-0">
                <h3 class="font-bold dark:text-white" id="dm-title">ç”¨æˆ·è¯¦æƒ…</h3>
                <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="text-gray-500 dark:text-slate-400">âœ•</button>
            </div>
            <div id="dm-content" class="flex-1 overflow-y-auto p-2 space-y-1 bg-white dark:bg-slate-900"></div>
        </div>
    </div>

    <!-- é”™è¯¯æç¤ºå¼¹çª— -->
    <div id="error-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/30 dark:bg-black/60 backdrop-blur-sm" onclick="this.parentElement.classList.add('hidden')"></div>
        <div class="relative bg-white dark:bg-slate-900 w-full max-w-md rounded-xl shadow-2xl z-10 overflow-hidden flex flex-col transition-colors duration-200">
            <div class="p-4 border-b bg-red-50 dark:bg-red-900/20 dark:border-red-900/30 flex items-center gap-2">
                <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 class="font-bold text-red-800 dark:text-red-300">æ“ä½œå¤±è´¥</h3>
            </div>
            <div id="error-content" class="p-6 text-sm text-gray-700 dark:text-slate-300 whitespace-pre-wrap break-words leading-relaxed overflow-y-auto max-h-[60vh]"></div>
            <div class="p-4 border-t bg-gray-50 dark:bg-slate-950 dark:border-slate-800 flex justify-end">
                <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="bg-gray-800 dark:bg-slate-700 text-white px-4 py-2 rounded hover:bg-gray-900 dark:hover:bg-slate-600 transition">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // ä¸»é¢˜åˆ‡æ¢é€»è¾‘
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        let currentQQ = localStorage.getItem('lastQQ') || '';
        let selectedGroups = [];

        document.addEventListener('DOMContentLoaded', () => {
            refreshUserList();
            if(currentQQ) selectUser(currentQQ);
            scanTermux();
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ç”¨æˆ·é€‰æ‹©èœå•
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('user-selector-menu');
            const btn = document.getElementById('user-selector-btn');
            if (!menu || !btn) return;
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        function showError(msg) {
            const modal = document.getElementById('error-modal');
            const content = document.getElementById('error-content');
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const html = msg.replace(urlRegex, (url) => {
                const cleanUrl = url.replace(/[.,;]$/, '');
                return `<a href="${cleanUrl}" target="_blank" class="text-blue-600 dark:text-blue-400 underline hover:text-blue-800 dark:hover:text-blue-300 break-all">${cleanUrl}</a>`;
            });
            content.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function openManageModal() {
            document.getElementById('manage-modal').classList.remove('hidden');
            scanTermux();
        }

        function switchManageTab(target) {
            document.querySelectorAll('.manage-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(target).classList.remove('hidden');
            document.querySelectorAll('.manage-tab-btn').forEach(el => {
                el.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                el.classList.add('border-transparent');
            });
            document.querySelector(`button[data-target="${target}"]`).classList.remove('border-transparent');
            document.querySelector(`button[data-target="${target}"]`).classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
        }

        async function refreshUserList() {
            const res = await fetch('/api/users');
            const users = await res.json();
            const container = document.getElementById('user-list-container');
            container.innerHTML = users.map(u => `
                <div class="flex justify-between items-center px-2 py-1.5 hover:bg-gray-100 dark:hover:bg-slate-800 rounded cursor-pointer group transition-colors">
                    <span onclick="selectUser('${u}')" class="flex-1 text-sm font-medium ${u === currentQQ ? 'text-blue-600 dark:text-blue-400' : 'text-gray-700 dark:text-slate-300'}">${u}</span>
                    <button onclick="deleteUser('${u}')" class="hidden group-hover:block text-xs text-red-400 hover:text-red-600 transition-colors">åˆ é™¤</button>
                </div>
            `).join('');
        }

        async function createUserFolder(inputId) {
            const qq = document.getElementById(inputId).value;
            if(!qq) return alert('è¯·å…ˆè¾“å…¥ QQ å·');
            try {
                const res = await fetch(`/api/users/${qq}/create_folder`, { method: 'POST' });
                const data = await res.json();
                if(res.ok) alert(data.detail);
                else alert('é”™è¯¯: ' + data.detail);
            } catch(e) { alert('è¯·æ±‚å¤±è´¥'); }
        }

        async function deleteUser(qq) {
            if(!confirm(`ç¡®è®¤åˆ é™¤ ${qq} çš„æ•°æ®å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(`/api/users/${qq}`, { method: 'DELETE' });
                if(!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }
                if (currentQQ === qq) {
                    currentQQ = '';
                    localStorage.removeItem('lastQQ');
                    location.reload();
                } else {
                    refreshUserList();
                }
            } catch(e) { alert("åˆ é™¤å¤±è´¥: " + e.message); }
        }

        function selectUser(qq) {
            currentQQ = qq;
            localStorage.setItem('lastQQ', qq);
            document.getElementById('current-user-display').innerText = qq;
            document.getElementById('user-selector-menu').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('analysis-view').classList.remove('hidden');
            
            // åˆ‡æ¢ç”¨æˆ·æ—¶æ¸…ç©ºä¹‹å‰çš„æ•°æ®å±•ç¤ºï¼Œä¼˜åŒ–ä½“éªŒ
            document.getElementById('tab1-content').innerHTML = '';
            document.getElementById('search-res-2').innerHTML = '';
            document.getElementById('tab2-content').innerHTML = '';
            document.getElementById('search-res-3').innerHTML = '';
            document.getElementById('sel-list').innerHTML = '';
            document.getElementById('tab3-content').innerHTML = '';
            selectedGroups = [];
            document.getElementById('sel-count').innerText = 0;
            document.getElementById('tab3-res-count').innerText = "0 äºº";
            
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ª Tab
            switchTab('tab1');
        }

        async function scanTermux() {
            const list = document.getElementById('termux-uid-list');
            try {
                const res = await fetch('/api/system/uids');
                const data = await res.json();
                if (!data.available) {
                    list.innerHTML = `<div class="text-red-500 dark:text-red-400 text-sm text-center py-4">${data.error || 'æ— æ³•è·å– UIDï¼Œé Termux ç¯å¢ƒæˆ–æ— æƒé™'}</div>`;
                    return;
                }
                list.innerHTML = data.uids.map(item => `
                    <div class="flex items-center justify-between border p-3 rounded-lg bg-gray-50 dark:bg-slate-800 dark:border-slate-700">
                        <div>
                            <div class="font-bold text-gray-800 dark:text-slate-200">${item.qq}</div>
                            <div class="text-xs text-gray-400 dark:text-slate-500 font-mono truncate max-w-[150px]">${item.nt_uid}</div>
                        </div>
                        <button onclick="runTermuxProcess('${item.qq}', '${item.nt_uid}')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded shadow transition-colors">ä¸€é”®æå–</button>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = `<div class="text-center text-sm text-gray-400 dark:text-slate-500">ç½‘ç»œé”™è¯¯</div>`;
            }
        }

        async function runTermuxProcess(qq, uid) {
            const cleanup = document.getElementById('termux-clean').checked;
            const btn = event.target;
            btn.innerText = 'å¤„ç†ä¸­...';
            btn.disabled = true;
            try {
                const res = await fetch('/api/users/termux_process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ qq_id: qq, nt_uid: uid, cleanup: cleanup })
                });
                if(res.ok) {
                    alert('æˆåŠŸï¼');
                    refreshUserList();
                    selectUser(qq);
                    document.getElementById('manage-modal').classList.add('hidden');
                } else {
                    const err = await res.json();
                    showError(err.detail);
                }
            } catch(e) { alert('è¯·æ±‚å¤±è´¥'); }
            btn.innerText = 'ä¸€é”®æå–';
            btn.disabled = false;
        }

        async function runManual(step) {
            const qq = document.getElementById('manual-qq').value;
            if(!qq) return alert('è¯·è¾“å…¥ QQ å·');
            const payload = {
                qq_id: qq,
                step: step,
                cleanup: true,
                nt_uid: document.getElementById('manual-ntuid').value || undefined,
                key: document.getElementById('manual-key').value || undefined
            };
            try {
                const res = await fetch('/api/users/manual_process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if(res.ok) {
                    alert('å¤„ç†æˆåŠŸ');
                    refreshUserList();
                    selectUser(qq);
                } else {
                    const err = await res.json();
                    showError(err.detail);
                }
            } catch(e) { alert('é”™è¯¯: ' + e); }
        }

        async function runJsonImport() {
            const qq = document.getElementById('json-qq').value;
            const fileInput = document.getElementById('json-file');
            if(!qq || !fileInput.files[0]) return alert('è¯·å¡«å†™ QQ å¹¶é€‰æ‹©æ–‡ä»¶');
            const formData = new FormData();
            formData.append('qq_id', qq);
            formData.append('file', fileInput.files[0]);
            try {
                const res = await fetch('/api/users/json_import', { method: 'POST', body: formData });
                if(res.ok) {
                    alert('å¯¼å…¥æˆåŠŸ');
                    refreshUserList();
                    selectUser(qq);
                } else { alert('å¯¼å…¥å¤±è´¥'); }
            } catch(e) { alert('é”™è¯¯'); }
        }

        document.getElementById('json-file').onchange = function() {
            document.getElementById('json-filename').innerText = this.files[0].name;
        };

        function switchTab(id) {
            ['tab1', 'tab2', 'tab3'].forEach(t => {
                document.getElementById(t).classList.add('hidden');
                document.getElementById('nav-'+t).classList.remove('bg-blue-50', 'text-blue-600', 'dark:bg-slate-800', 'dark:text-blue-400');
            });
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('nav-'+id).classList.add('bg-blue-50', 'text-blue-600', 'dark:bg-slate-800', 'dark:text-blue-400');
            if(id === 'tab1' && !document.getElementById('tab1-content').hasChildNodes()) loadFrequentUsers();
        }

        async function loadFrequentUsers() {
            if(!currentQQ) return;
            const res = await fetch(`/api/analysis/${currentQQ}/frequent_users?min_groups=2`);
            const data = await res.json();
            const groups = {};
            data.forEach(u => {
                if(!groups[u.group_count]) groups[u.group_count] = [];
                groups[u.group_count].push(u);
            });
            const html = Object.keys(groups).sort((a,b)=>b-a).map(cnt => `
                <div class="bg-white dark:bg-slate-900 rounded-lg shadow-sm border border-gray-200 dark:border-slate-800 overflow-hidden transition-colors duration-200">
                    <div class="px-4 py-3 bg-gray-50 dark:bg-slate-950 flex justify-between items-center cursor-pointer select-none" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span class="font-bold text-sm text-gray-700 dark:text-slate-300">å…±åŒç¾¤èŠæ•°: ${cnt} <span class="text-gray-400 dark:text-slate-500 font-normal ml-2">(${groups[cnt].length}äºº)</span></span>
                        <span class="text-gray-400 dark:text-slate-500 text-xs">â–¼</span>
                    </div>
                    <div class="hidden p-2 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 border-t border-gray-100 dark:border-slate-800">
                        ${groups[cnt].map(u => `
                            <div onclick="showDetail('${u.user_id}', '${u.user_name}')" class="p-2 hover:bg-blue-50 dark:hover:bg-slate-800 rounded border border-transparent hover:border-blue-100 dark:hover:border-slate-700 cursor-pointer transition-colors group">
                                <div class="font-medium text-sm truncate text-gray-800 dark:text-slate-200 group-hover:text-blue-700 dark:group-hover:text-blue-400 transition-colors">${u.user_name||'æœªçŸ¥'}</div>
                                <div class="text-xs text-gray-400 dark:text-slate-500 truncate">${u.user_id}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('tab1-content').innerHTML = html || '<div class="text-center py-10 text-gray-400 dark:text-slate-500">æ— æ•°æ®</div>';
        }

        let searchTimer;
        function debounceSearch(val, targetId) {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => doSearch(val, targetId), 300);
        }

        async function doSearch(val, targetId) {
            if(!val) return;
            const res = await fetch(`/api/analysis/${currentQQ}/search_groups?q=${encodeURIComponent(val)}`);
            const data = await res.json();
            const html = data.map(g => `
                <div onclick="${targetId === 'search-res-2' ? `loadGroupOverlap('${g.group_id}', '${g.group_name}')` : `addIntersect('${g.group_id}', '${g.group_name}')`}" 
                     class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded cursor-pointer text-sm truncate border-b border-gray-50 dark:border-slate-800 text-gray-700 dark:text-slate-300 transition-colors">
                    ${g.group_name}
                </div>
            `).join('');
            document.getElementById(targetId).innerHTML = html;
        }

        async function loadGroupOverlap(gid, gname) {
            document.getElementById('tab2-header').innerHTML = `æŸ¥è¯¢: <span class="text-blue-600 dark:text-blue-400">${gname}</span>`;
            const res = await fetch(`/api/analysis/${currentQQ}/group_overlap?group_id=${gid}`);
            const data = await res.json();
            document.getElementById('tab2-content').innerHTML = data.map(u => `
                <div onclick="showDetail('${u.user_id}', '${u.user_name}')" class="flex justify-between items-center p-2 hover:bg-gray-50 dark:hover:bg-slate-800 border-b border-gray-100 dark:border-slate-800 transition-colors cursor-pointer group">
                    <div>
                        <div class="font-bold text-sm text-gray-700 dark:text-slate-200 group-hover:text-blue-700 dark:group-hover:text-blue-400 transition-colors">${u.user_name}</div>
                        <div class="text-xs text-gray-400 dark:text-slate-500">${u.user_id}</div>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded text-xs font-bold">ç¾¤æ•°: ${u.group_count}</div>
                </div>
            `).join('');
        }

        function addIntersect(gid, gname) {
            if(selectedGroups.find(g => g.id === gid)) return;
            selectedGroups.push({id: gid, name: gname});
            renderSel();
        }

        function renderSel() {
            document.getElementById('sel-count').innerText = selectedGroups.length;
            document.getElementById('sel-list').innerHTML = selectedGroups.map(g => `
                <div class="flex justify-between items-center bg-blue-50 dark:bg-slate-800 p-2 rounded text-sm mb-1 transition-colors">
                    <span class="truncate text-blue-800 dark:text-blue-300">${g.name}</span>
                    <button onclick="selectedGroups = selectedGroups.filter(x=>x.id!=='${g.id}');renderSel();" class="text-red-400 hover:text-red-600 dark:hover:text-red-300">Ã—</button>
                </div>
            `).join('');
        }

        async function runIntersection() {
            if(selectedGroups.length < 2) return alert('è‡³å°‘é€‰2ä¸ªç¾¤');
            const res = await fetch(`/api/analysis/${currentQQ}/intersection`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({group_ids: selectedGroups.map(g=>g.id)})
            });
            const data = await res.json();
            document.getElementById('tab3-res-count').innerText = data.length + ' äºº';
            document.getElementById('tab3-content').innerHTML = data.map(u => `
                <div class="bg-gray-50 dark:bg-slate-800 p-2 rounded border border-gray-200 dark:border-slate-700 transition-colors">
                    <div class="font-bold text-sm truncate dark:text-slate-200">${u.user_name}</div>
                    <div class="text-xs text-gray-400 dark:text-slate-500">${u.user_id}</div>
                </div>
            `).join('');
        }

        async function showDetail(uid, uname) {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('dm-content');
            modal.classList.remove('hidden');
            document.getElementById('dm-title').innerText = uname || uid;
            content.innerHTML = '<div class="text-gray-400 dark:text-slate-500 text-sm text-center py-4">åŠ è½½ä¸­...</div>';
            const res = await fetch(`/api/analysis/${currentQQ}/user_groups/${uid}`);
            const data = await res.json();
            content.innerHTML = data.map(g => `
                <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-slate-800 rounded border border-gray-100 dark:border-slate-700 text-sm transition-colors">
                    <span class="truncate max-w-[60%] text-gray-700 dark:text-slate-300">${g.group_name}</span>
                    <span class="text-xs bg-white dark:bg-slate-900 border dark:border-slate-600 px-1 rounded text-gray-500 dark:text-slate-400 max-w-[35%] truncate">${g.nickname || '-'}</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>